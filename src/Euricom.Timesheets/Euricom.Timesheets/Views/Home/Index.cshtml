@model Euricom.Timesheets.Models.HomeModel

@{
    ViewBag.Title = "Home Page";
}

@section Head {
    <script type="text/javascript">
        $(function () {
            timesheets.Day = function (day, isWeekend) {
                this.day = day;
                this.isWeekend = isWeekend;

                this.cssclass = ko.computed(function () {
                    return this.isWeekend ? "weekend" : "regularDay";
                }, this);

                this.formattedDay = ko.computed(function () {
                    return this.day.getDate() + "/" + (this.day.getMonth() + 1) + "/" + this.day.getFullYear();
                }, this);
            };

            timesheets.ViewModel = function (days) {
                this.days = ko.observableArray(days);
                this.loadNewDays = function () {
                    var self = this;

                    this._fetchDates(function (days) {
                        // this looks stupid, need to review
                        self.days.removeAll();
                        for (var day in days) {
                            console.log(days[day]);

                            self.days.push(days[day]);
                        }
                    });
                };
                this.selectedMonth = ko.observable("");
                this.selectedYear = ko.observable("");
                this._fetchDates = function(callback) {
                    var requestUrl = '@Url.RouteUrl("DefaultApi", new { httproute = "", controller = "timesheets" })';
                    requestUrl += '/' + this.selectedYear() + '/' + this.selectedMonth();

                    $.get(requestUrl, function (data) {
                        var dates = [];
                        jQuery.each(data, function (i, val) {
                            dates.push(new timesheets.Day(new Date(val.Date), val.IsWeekend));
                        });

                        callback(dates);
                    });
                };
            };

            ko.applyBindings(new timesheets.ViewModel([]));
        });        
       
    </script>
}

@using (Html.BeginForm())
{
    <table>
        <tr>
            <td>@Html.LabelFor(m => m.Month)</td>
            <td>@Html.DropDownListFor(m => m.Month, Model.Months, new { data_bind = "value:selectedMonth" })</td>
        </tr>

        <tr>
            <td>@Html.LabelFor(m => m.Year)</td>
            <td>@Html.DropDownListFor(m => m.Year, Model.Years, new { data_bind = "value:selectedYear" })</td>
        </tr>

        <tr>
            <td colspan="2" align="right">
                <input type="submit" name="Submit" value="Submit" data-bind="click: loadNewDays" />
            </td>
        </tr>
    </table>
}

<table id="calendar">
    <tbody data-bind="foreach: days">
        <tr>
            <td data-bind="text: formattedDay, attr: { 'class': cssclass }"></td>
        </tr>
    </tbody>
</table>

